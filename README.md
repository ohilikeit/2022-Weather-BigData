![11111 (1)](https://user-images.githubusercontent.com/37128004/197784240-f16276e3-01ef-4378-a8bc-0316d50f0aa4.png)
# Weather Bigdata Competition
기상청 주최의 2022 날씨 빅데이터 콘테스트에 참여한 결과물이다. 

## Introduction
기상과 전국 심뇌혈관계질환 발생 간의 연관성을 밝히고 환자 수를 예측하는 모델을 개발한다. [날씨마루](https://bd.kma.go.kr/kma2020/svc/main.do) 플랫폼을 활용하여 모델 개발에 필요한 기상 데이터를 참가자가 직접 뽑아서 활용해야했다. 

## Data
### 제공 데이터
**1. 지역별 심뇌혈관 발생빈도**
```
yyyymmdd	area	sex	frequency
1	20120101	강원	1	3.0
2	20120101	강원	2	3.0
3	20120101	경기	1	4.0
4	20120101	경기	2	5.0
5	20120101	경남	1	2.0
...	...	...	...	...
12441	20161231	제주	2	NaN
12425	20161231	충남	1	NaN
12442	20161231	충남	2	NaN
12426	20161231	충북	1	NaN
12443	20161231	충북	2	NaN
62118 rows × 4 columns
```
**2. 기상예보데이터**
- 기간 : 2012 ~ 2016
- 활용 데이터 : 3시간기온, 습도, 일최고기온, 일최저기온, 풍속, 12시간강수량, 12시간신적설
- 제공처 : 날씨 빅데이터 콘테스트
### 외부 데이터
**1. 관측지점정보**
- 기간: 2012 ~ 2016
- 출처 : 기상자료개방포털 > 데이터 > 메타데이터 > 지점정보 > [관측지점정보](https://data.kma.go.kr/tmeta/stn/selectStnList.do)
```
  stn_id	area
0	90	강원
1	92	강원
2	95	강원
3	96	경북
4	98	경기
...	...	...
687	963	울산
688	966	인천
689	967	인천
690	968	부산
691	969	부산
692 rows × 2 columns
```
**2. 행정구역(시군구)별, 성별 인구수**
- 기간: 2012 ~ 2016
- 출처: KOSIS > [행정구역(시군구)별, 성별 인구수](https://kosis.kr/statHtml/statHtml.do?orgId=101&tblId=DT_1B040A3)
```
        yyyymmdd	area	sex	frequency	tot_person	num_risk_age
0	20120101	강원	1	3.0	772718	    322636.0
1	20120101	강원	2	3.0	762617	    229447.0
2	20120101	경기	1	4.0	6020446	    2054584.0
3	20120101	경기	2	5.0	5928150	    1182747.0
4	20120101	경남	1	2.0	1665308	    622268.0
...	...	...	...	...	...	...
62113	20161231	제주	2	NaN	319052	    94654.0
62114	20161231	충남	1	NaN	1064765	    471322.0
62115	20161231	충남	2	NaN	1031962	    348117.0
62116	20161231	충북	1	NaN	803240	    358361.0
62117	20161231	충북	2	NaN	788385	    258676.0
62118 rows × 6 columns
```
**3. 생활지수 예보**
- 기간: 2012 ~ 2016
- 활용 데이터: A03(체감온도), A04(동상가능지수), A05(열지수), A06(불쾌지수)
- 출처: 날씨마루
```
yyyymmdd	area	sex	frequency	A03_t1	A03_t2	A03_t3	A04_t1	A04_t2	A04_t3	A05_t1	A05_t2	A05_t3	A06_t1	A06_t2	A06_t3
0	20120101	강원	1	3.0	-3.006250	-1.112500	-1.112500	-2.677778	-0.455556	0.600000	0.181250	1.050000	1.425000	33.268750	39.906250	42.375000
1	20120101	강원	2	3.0	-3.006250	-1.112500	-1.112500	-2.677778	-0.455556	0.600000	0.181250	1.050000	1.425000	33.268750	39.906250	42.375000
2	20120101	경기	1	4.0	-4.521429	-3.050000	-3.367857	-2.566667	-0.300000	0.666667	0.000000	0.067857	0.342857	32.271429	38.539285	39.732143
3	20120101	경기	2	5.0	-4.521429	-3.050000	-3.367857	-2.566667	-0.300000	0.666667	0.000000	0.067857	0.342857	32.271429	38.539285	39.732143
4	20120101	경남	1	2.0	-0.660000	3.120000	3.275000	0.133333	4.833333	5.766667	0.870000	4.690000	5.830000	36.465000	45.705000	47.840000
...	...	...	...	...	...	...	...	...	...	...	...	...	...	...	...	...
62113	20161231	제주	2	NaN	2.659574	6.234043	6.787234	4.787234	8.212766	8.723404	4.787234	8.127660	8.702128	NaN	NaN	NaN
62114	20161231	충남	1	NaN	-0.017857	3.593750	5.500000	0.080357	3.892857	6.035714	0.558036	3.848214	6.026786	NaN	NaN	NaN
62115	20161231	충남	2	NaN	-0.017857	3.593750	5.500000	0.080357	3.892857	6.035714	0.558036	3.848214	6.026786	NaN	NaN	NaN
62116	20161231	충북	1	NaN	-2.166667	0.285714	2.226190	-2.166667	1.922619	3.964286	0.000000	1.916667	3.922619	NaN	NaN	NaN
62117	20161231	충북	2	NaN	-2.166667	0.285714	2.226190	-2.166667	1.922619	3.964286	0.000000	1.916667	3.922619	NaN	NaN	NaN
62118 rows × 16 columns
```
**4. 대기오염**
- 기간: 2012 ~ 2016
- 활용 데이터 : NO2, CO, SO2, O3, PM10
- 출처: 에어코리아 > 통계정보 > [확정자료 다운로드 ](https://www.airkorea.or.kr/web/last_amb_hour_data)
```
yyyymmdd	area	sex	frequency	SO2_mean	CO_mean	O3_mean	NO2_mean	PM10_mean
0	20120101	강원	1	3.0	0.010033	1.012879	0.019098	0.020873	81.004920
1	20120101	경기	1	4.0	0.009029	0.957298	0.012696	0.030727	85.095743
2	20120101	경남	1	2.0	0.008975	0.653175	0.021270	0.017499	61.997379
3	20120101	경북	1	6.0	0.009128	0.753123	0.022520	0.015224	71.985180
4	20120101	광주	1	0.0	0.005657	0.742130	0.014366	0.024338	50.203704
...	...	...	...	...	...	...	...	...	...
62113	20161231	전남	2	NaN	0.005292	0.577451	0.016422	0.020574	32.326121
62114	20161231	전북	2	NaN	0.003716	0.592187	0.012385	0.023351	47.750308
62115	20161231	제주	2	NaN	0.001338	0.191411	0.029063	0.012552	24.784515
62116	20161231	충남	2	NaN	0.002730	0.631250	0.014071	0.022291	42.137500
62117	20161231	충북	2	NaN	0.004405	0.905903	0.005111	0.026913	51.430227
62118 rows × 9 columns
```
### 통합
<img src="https://user-images.githubusercontent.com/37128004/197778511-b633d453-1c01-4f5f-bb76-bd817b765054.jpeg" width="700" height="400"/>

```python
yyyymmdd	area	sex	frequency	SO2_mean	CO_mean	O3_mean	NO2_mean	PM10_mean
0	20120101	강원	1	3.0	0.010033	1.012879	0.019098	0.020873	81.004920
1	20120101	경기	1	4.0	0.009029	0.957298	0.012696	0.030727	85.095743
2	20120101	경남	1	2.0	0.008975	0.653175	0.021270	0.017499	61.997379
3	20120101	경북	1	6.0	0.009128	0.753123	0.022520	0.015224	71.985180
4	20120101	광주	1	0.0	0.005657	0.742130	0.014366	0.024338	50.203704
...	...	...	...	...	...	...	...	...	...
62113	20161231	전남	2	NaN	0.005292	0.577451	0.016422	0.020574	32.326121
62114	20161231	전북	2	NaN	0.003716	0.592187	0.012385	0.023351	47.750308
62115	20161231	제주	2	NaN	0.001338	0.191411	0.029063	0.012552	24.784515
62116	20161231	충남	2	NaN	0.002730	0.631250	0.014071	0.022291	42.137500
62117	20161231	충북	2	NaN	0.004405	0.905903	0.005111	0.026913	51.430227
62118 rows × 9 columns
```

## Feature Engineering
<img src="https://user-images.githubusercontent.com/37128004/197777486-3b16a6b9-3f5a-487d-a0ea-3d5e1af85ac1.png"  width="700" height="900"/>

## Model
<img src="https://user-images.githubusercontent.com/37128004/197779082-527f29b1-8ac8-4d81-b83a-e146eaa2036d.jpeg" width="700" height="120"/>

### 3 models hyperparameter tuning
Optuna의 TPESampler를 활용하여 세 모델(CatBoost, LGBM, XGB)의 하이퍼파라미터 튜닝을 진행하였다. 앙상블도 진행해봤으나 LGBM 단일 모델의 성능이 가장 좋았다. 
<img src="https://user-images.githubusercontent.com/37128004/197779859-ddfb03a5-80a6-4253-b272-3281d9880568.jpeg" width="700" height="300"/>

### feature Importance
기상 데이터를 이용하여 예측을 하는 것이 목적이었으나 feature importance 상으로는 지역, 인구 변수들이 모델학습의 대부분을 차지하였다. 
<img src="https://user-images.githubusercontent.com/37128004/197780373-c8ad045d-2aa0-4c90-9fac-90d013b408bd.png" width="700" height="300"/>

### Inference time technique
년도 별 평균적인 질환발생건수의 증가분을 곱해주어 시계열적인 정보를 보정해주었다. 
```
LGBM_pred = LGBM.predict(test)
submit.frequency = LGBM_pred * 1.05
```

## Conclusion
- 결론적으로는, 심뇌혈관계 질환 발생건수와 기상과의 명확한 상관관계는 데이터상으론 찾지 못했다.
- 모델 학습의 대부분이 지역, 인구와 같은 다른 변수에 의해 결정되었고, 큰 상관성을 보일 것으로 예상했던 기온, 적설량도 별 의미 없었다.
- raw data를 입맛대로 가공하는 과정이 매우 어렵다는 점을 깨달았다.(전체 시간의 70% 이상을 투입했다.)
- 세 모델의 앙상블 효과가 기대 이하인 것은 동일한 gradient boosting 기반의 알고리즘을 대상으로 했기 때문으로 예상한다.
